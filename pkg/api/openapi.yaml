openapi: 3.1.0
info:
  title: Tennex Backend API
  description: WhatsApp Bridge Backend REST API
  version: 1.0.0
  contact:
    name: Tennex Team
servers:
  - url: http://localhost:8082
    description: Local development server

paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      tags:
        - System
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /outbox:
    post:
      summary: Send a message (queue for delivery)
      operationId: createOutboxMessage
      tags:
        - Messaging
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '201':
          description: Message queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sync:
    get:
      summary: Sync events since a sequence number
      operationId: syncEvents
      tags:
        - Sync
      parameters:
        - name: account_id
          in: query
          required: true
          schema:
            type: string
          description: Account identifier
        - name: since
          in: query
          required: false
          schema:
            type: integer
            format: int64
            default: 0
          description: Sequence number to sync from
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Maximum number of events to return
      responses:
        '200':
          description: Events retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /qr:
    get:
      summary: Get QR code for WhatsApp pairing
      operationId: getQRCode
      tags:
        - Authentication
      parameters:
        - name: account_id
          in: query
          required: true
          schema:
            type: string
          description: Account identifier for pairing
      responses:
        '200':
          description: QR code generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QRResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Failed to generate QR code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /accounts:
    get:
      summary: List all accounts
      operationId: listAccounts
      tags:
        - Accounts
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Accounts retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountsResponse'

  /accounts/{account_id}:
    get:
      summary: Get account details
      operationId: getAccount
      tags:
        - Accounts
      parameters:
        - name: account_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Account details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '404':
          description: Account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/register:
    post:
      summary: Register a new user
      operationId: registerUser
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request or user already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login user
      operationId: loginUser
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      summary: Get current user information
      operationId: getCurrentUser
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sync/conversations/{integration_id}:
    get:
      summary: Sync conversations for a user integration
      operationId: syncConversations
      tags:
        - Sync
      security:
        - bearerAuth: []
      parameters:
        - name: integration_id
          in: path
          required: true
          schema:
            type: integer
          description: User integration ID
        - name: since_seq
          in: query
          required: false
          schema:
            type: integer
            format: int64
            default: 0
          description: Fetch conversations since this sequence number
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 100
            maximum: 1000
      responses:
        '200':
          description: Conversations synced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncConversationsResponse'

  /sync/messages/{integration_id}:
    get:
      summary: Sync messages for a user integration (across all conversations)
      operationId: syncMessages
      tags:
        - Sync
      security:
        - bearerAuth: []
      parameters:
        - name: integration_id
          in: path
          required: true
          schema:
            type: integer
          description: User integration ID
        - name: since_seq
          in: query
          required: false
          schema:
            type: integer
            format: int64
            default: 0
          description: Fetch messages since this sequence number
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 1500
            maximum: 2000
      responses:
        '200':
          description: Messages synced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncMessagesResponse'

  /sync/contacts/{integration_id}:
    get:
      summary: Sync contacts for a user integration
      operationId: syncContacts
      tags:
        - Sync
      security:
        - bearerAuth: []
      parameters:
        - name: integration_id
          in: path
          required: true
          schema:
            type: integer
          description: User integration ID
        - name: since_seq
          in: query
          required: false
          schema:
            type: integer
            format: int64
            default: 0
          description: Fetch contacts since this sequence number
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 500
            maximum: 1000
      responses:
        '200':
          description: Contacts synced successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncContactsResponse'

  /sync/status/{integration_id}:
    get:
      summary: Get current sync status for a user integration
      operationId: getSyncStatus
      tags:
        - Sync
      security:
        - bearerAuth: []
      parameters:
        - name: integration_id
          in: path
          required: true
          schema:
            type: integer
          description: User integration ID
      responses:
        '200':
          description: Sync status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncStatusResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          example: "ok"
        timestamp:
          type: string
          format: date-time
        version:
          type: string
          example: "1.0.0"

    SendMessageRequest:
      type: object
      required:
        - client_msg_uuid
        - account_id
        - convo_id
        - message_type
        - content
      properties:
        client_msg_uuid:
          type: string
          format: uuid
          description: Client-provided UUID for idempotency
        account_id:
          type: string
          description: Account sending the message
        convo_id:
          type: string
          description: Conversation/chat identifier
        message_type:
          type: string
          enum: [text, image, audio, video, document]
          description: Type of message content
        content:
          type: object
          description: Message content (varies by type)
        reply_to:
          type: string
          format: uuid
          description: Optional - reply to this message ID

    SendMessageResponse:
      type: object
      required:
        - server_msg_id
        - status
        - client_msg_uuid
      properties:
        server_msg_id:
          type: integer
          format: int64
          description: Server-assigned sequence number
        status:
          type: string
          enum: [queued, sending]
          description: Current message status
        client_msg_uuid:
          type: string
          format: uuid
          description: Echo of client UUID

    SyncResponse:
      type: object
      required:
        - events
        - next_seq
        - has_more
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
        next_seq:
          type: integer
          format: int64
          description: Next sequence number for pagination
        has_more:
          type: boolean
          description: Whether more events are available

    Event:
      type: object
      required:
        - seq
        - id
        - timestamp
        - type
        - account_id
        - convo_id
        - payload
      properties:
        seq:
          type: integer
          format: int64
          description: Sequence number for ordering
        id:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
        type:
          type: string
          enum: [msg_in, msg_out_pending, msg_out_sent, msg_delivery, presence, contact_update, history_sync]
        account_id:
          type: string
        device_id:
          type: string
        convo_id:
          type: string
        wa_message_id:
          type: string
          description: WhatsApp message identifier
        sender_jid:
          type: string
          description: WhatsApp JID of sender
        payload:
          type: object
          description: Event-specific data
        attachment_ref:
          type: object
          description: Reference to media attachments

    QRResponse:
      type: object
      required:
        - qr_code_png
        - pairing_session_id
      properties:
        qr_code_png:
          type: string
          format: byte
          description: Base64-encoded PNG image
        pairing_session_id:
          type: string
          description: Session identifier for this pairing attempt
        expires_at:
          type: string
          format: date-time
          description: When this QR code expires

    Account:
      type: object
      required:
        - id
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
        wa_jid:
          type: string
          description: WhatsApp JID
        display_name:
          type: string
        avatar_url:
          type: string
        status:
          type: string
          enum: [connected, disconnected, connecting, error]
        last_seen:
          type: string
          format: date-time
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AccountsResponse:
      type: object
      required:
        - accounts
        - total
      properties:
        accounts:
          type: array
          items:
            $ref: '#/components/schemas/Account'
        total:
          type: integer
          description: Total number of accounts

    ErrorResponse:
      type: object
      required:
        - error
        - timestamp
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
        details:
          type: object
          description: Additional error details
        timestamp:
          type: string
          format: date-time

    RegisterRequest:
      type: object
      required:
        - username
        - password
        - email
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 30
          pattern: ^[a-zA-Z0-9_]+$
          description: Unique username (alphanumeric and underscore only)
        password:
          type: string
          minLength: 8
          description: Password (minimum 8 characters)
        email:
          type: string
          format: email
          description: User email address
        full_name:
          type: string
          maxLength: 100
          description: Optional full name

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: Username or email
        password:
          type: string
          description: User password

    AuthResponse:
      type: object
      required:
        - user
        - token
        - expires_at
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: JWT access token
        expires_at:
          type: string
          format: date-time
          description: Token expiration time

    User:
      type: object
      required:
        - id
        - username
        - email
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique user identifier
        username:
          type: string
          description: Username
        email:
          type: string
          format: email
          description: User email
        full_name:
          type: string
          description: Full name
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SyncConversationsResponse:
      type: object
      required:
        - conversations
        - latest_seq
        - has_more
      properties:
        conversations:
          type: array
          items:
            $ref: '#/components/schemas/Conversation'
        latest_seq:
          type: integer
          format: int64
          description: Latest sequence number in this batch (use as cursor for next request)
        has_more:
          type: boolean
          description: Whether more conversations are available
        total_count:
          type: integer
          description: Total count of new conversations

    SyncMessagesResponse:
      type: object
      required:
        - messages
        - latest_seq
        - has_more
      properties:
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        latest_seq:
          type: integer
          format: int64
          description: Latest sequence number in this batch (use as cursor for next request)
        has_more:
          type: boolean
          description: Whether more messages are available
        total_count:
          type: integer
          description: Total count of new messages

    SyncContactsResponse:
      type: object
      required:
        - contacts
        - latest_seq
        - has_more
      properties:
        contacts:
          type: array
          items:
            $ref: '#/components/schemas/Contact'
        latest_seq:
          type: integer
          format: int64
          description: Latest sequence number in this batch (use as cursor for next request)
        has_more:
          type: boolean
          description: Whether more contacts are available
        total_count:
          type: integer
          description: Total count of new contacts

    SyncStatusResponse:
      type: object
      required:
        - latest_conversation_seq
        - latest_message_seq
        - latest_contact_seq
      properties:
        latest_conversation_seq:
          type: integer
          format: int64
          description: Current latest conversation sequence number
        latest_message_seq:
          type: integer
          format: int64
          description: Current latest message sequence number
        latest_contact_seq:
          type: integer
          format: int64
          description: Current latest contact sequence number

    Conversation:
      type: object
      properties:
        seq:
          type: integer
          format: int64
        id:
          type: string
          format: uuid
        user_integration_id:
          type: integer
        external_conversation_id:
          type: string
        integration_type:
          type: string
        conversation_type:
          type: string
        name:
          type: string
        description:
          type: string
        avatar_url:
          type: string
        is_archived:
          type: boolean
        is_pinned:
          type: boolean
        is_muted:
          type: boolean
        unread_count:
          type: integer
        total_message_count:
          type: integer
        last_message_at:
          type: string
          format: date-time
        last_activity_at:
          type: string
          format: date-time
        platform_metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Message:
      type: object
      properties:
        seq:
          type: integer
          format: int64
        id:
          type: string
          format: uuid
        conversation_id:
          type: string
          format: uuid
        external_message_id:
          type: string
        integration_type:
          type: string
        sender_external_id:
          type: string
        sender_display_name:
          type: string
        message_type:
          type: string
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        is_from_me:
          type: boolean
        is_forwarded:
          type: boolean
        is_deleted:
          type: boolean
        delivery_status:
          type: string
        platform_metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Contact:
      type: object
      properties:
        seq:
          type: integer
          format: int64
        id:
          type: string
          format: uuid
        user_integration_id:
          type: integer
        external_contact_id:
          type: string
        integration_type:
          type: string
        display_name:
          type: string
        first_name:
          type: string
        last_name:
          type: string
        phone_number:
          type: string
        username:
          type: string
        is_blocked:
          type: boolean
        is_favorite:
          type: boolean
        last_seen:
          type: string
          format: date-time
        avatar_url:
          type: string
        platform_metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
